<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.webix.com/edge/webix.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet"
        type="text/css">
    <link rel="stylesheet" href="/static/custom.css">
    <script src="https://cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <title>{{title}}</title>
</head>

<body>
    <script>
        var updateRole = false;
        function deleteSupplier(supplierId) {
            webix.confirm({
                title: "Delete Supplier",
                text: `Are you sure you want to delete supplier ${supplierId}?`,
                ok: "Yes",
                cancel: "No",
                callback: function (result) {
                    if (result) {
                        webix.ajax().headers({ "Content-Type": "application/json" })
                            .del("/api/retailSupply/supplierDeleter", { _id: supplierId }, function (response) {
                                webix.message("Supplier deleted successfully");
                                $$("supplierDatatable").clearAll();
                                $$("supplierDatatable").load("/api/retailSupply/suppliersGetter");
                            }).fail(function (xhr) {
                                try {
                                    var response = JSON.parse(xhr.responseText);
                                    webix.message({
                                        type: "error",
                                        text: response.message
                                    });
                                } catch (e) {
                                    webix.message({ type: "error", text: "An unexpected error occurred." });
                                }
                            });
                    }
                }
            });
        }
        function deleteRetail(retailId) {
            webix.confirm({
                title: "Delete Retail",
                text: `Are you sure you want to delete retail ${retailId}?`,
                ok: "Yes",
                cancel: "No",
                callback: function (result) {
                    if (result) {
                        webix.ajax().headers({ "Content-Type": "application/json" })
                            .del("/api/retailSupply/retailDeleter", { _id: retailId }, function (response) {
                                webix.message("Retail deleted successfully");
                                $$("retailDatatable").clearAll();
                                $$("retailDatatable").load("/api/retailSupply/retailGetter");
                            }).fail(function (xhr) {
                                try {
                                    var response = JSON.parse(xhr.responseText);
                                    webix.message({
                                        type: "error",
                                        text: response.message
                                    });
                                } catch (e) {
                                    webix.message({ type: "error", text: "An unexpected error occurred." });
                                }
                            });
                    }
                }
            });
        }
        webix.ready(function () {
            webix.attachEvent("onAjaxError", function (xhr) {
                if (xhr.status === 401) {
                    window.location.href = "/";
                }
            });
            webix.ui({
                responsive: true,
                type: "clean",
                rows: [{
                    view: "toolbar",
                    height: 65,
                    padding: 10,
                    elements: [{
                        view: "label",
                        label: "",
                        css: "logo",
                        width: 175,
                        height: 50,
                        type: "webix_secondary",
                        click: function () {
                            window.location.href = "/";
                        }
                    },
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {},
                    {
                        view: "label",
                        width: 170,
                        label: "Hello! {{name}} As {{role}}",
                        autowidth: true,
                    },
                    {
                        view: "button",
                        width: 130,
                        label: " Logout",
                        click: function () {
                            window.location.href = '/users/logout';
                        }
                    },
                    {
                        width: 10
                    }
                    ]
                },
                {
                    type: "clean",
                    cols: [{
                        view: "sidebar",
                        id: "mainSidebar",
                        css: "sidebar-bg",
                        collapsed: true,
                        width: 250,
                        value: "dashboard",
                        data: [{
                            id: "dashboard",
                            icon: "mdi mdi-home",
                            value: "Dashboard"
                        },
                        // {% if Perm['retail and shipment']%}
                        {
                            id: "supplyAndRetailManagement",
                            icon: "mdi mdi-city",
                            value: "Supply and Retail Management",
                        },
                        // {% endif %}
                        // {% if Perm['stock management'] %}
                        {
                            id: "product_management",
                            icon: "mdi mdi-archive",
                            value: "Products management"
                        },
                        // {% endif %}
                        // {% if Perm['account management'] %}
                        {
                            id: "users_management",
                            icon: "mdi mdi-account-supervisor",
                            value: "Users management"
                        },
                            // {% endif %}
                        ]
                    },
                    {
                        view: "scrollview",
                        scroll: "y",
                        body: {
                            type: "clean",
                            paddingX: 30,
                            rows: [{
                                height: 70,
                                cols: [{
                                    type: "clean",
                                    template: "<H1>{{title}}</H1>",
                                },
                                {}
                                ]
                            },
                            {
                                type: "clean",
                                cols: [
                                    {
                                        view: "label",
                                        type: "clean",
                                        label: "Supplier Creator",
                                        height: 30
                                    },
                                    {
                                        view: "label",
                                        type: "clean",
                                        label: "Retail Creator",
                                        height: 30
                                    }
                                ]
                            },
                            {
                                type: "clean",
                                cols: [
                                    {
                                        paddingX: 5,
                                        type: "clean",
                                        rows: [
                                            {
                                                type: "clean",
                                                view: "form",
                                                id: "supplierForm",
                                                elements: [
                                                    {
                                                        id: "supplierIdForm",
                                                        name: "_id",
                                                        hidden: true
                                                    },
                                                    {
                                                        id: "supplierNameForm",
                                                        name: "supplierName",
                                                        labelWidth: 170,
                                                        label: "Supplier Name",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "supplierContactPersonForm",
                                                        name: "contactPerson",
                                                        labelWidth: 170,
                                                        label: "Supplier Contact Person",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "supplierEmailForm",
                                                        name: "email",
                                                        labelWidth: 170,
                                                        label: "Supplier Email",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "supplierPhoneForm",
                                                        name: "phone",
                                                        view: "text",
                                                        labelWidth: 170,
                                                        label: "Supplier Phone Number",
                                                        attributes: {
                                                            maxlength: 13
                                                        },
                                                        pattern: {
                                                            mask: "####-####-#####"
                                                        },
                                                        validate: function (value) {

                                                            return value
                                                                .length >= 10 &&
                                                                /^\d+$/.test(
                                                                    value
                                                                );
                                                        },
                                                        required: true
                                                    },
                                                    {
                                                        id: "supplierAddressForm",
                                                        name: "address",
                                                        labelWidth: 170,
                                                        label: "Supplier Address",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 50
                                                        }
                                                    }
                                                ],
                                                rules: {
                                                    "email": function (value) {
                                                        if (!webix.rules.isNotEmpty(
                                                            value))
                                                            return false;
                                                        return webix.rules.isEmail(
                                                            value);
                                                    }, "phone": function (value) {
                                                        return webix.rules.isNotEmpty(value) && !isNaN(value) && value.length >= 10 && /^\d+$/.test(value) && value.length < 14;
                                                    }
                                                },
                                                on: {
                                                    "onValidationError": function (id, obj, value) {
                                                        webix.message({
                                                            type: "error",
                                                            text: "Please Imput data correctly"
                                                        });
                                                    }
                                                }
                                            },
                                            {
                                                paddingY: 20,
                                                cols: [
                                                    {
                                                        view: "button",
                                                        value: "Cancel",
                                                        click: function () {
                                                            $$("supplierForm").clear();
                                                        }
                                                    },
                                                    {
                                                        view: "button",
                                                        css: "webix_primary",
                                                        value: "Add Supplier Data",
                                                        click: function () {
                                                            let form = $$("supplierForm");
                                                            let datatable = $$("supplierDatatable");
                                                            if (form.validate()) {
                                                                webix.ajax()
                                                                    .headers({ "Content-Type": "application/json" })
                                                                    .post("/api/retailSupply/supplierCreator", form.getValues(), function (response) {
                                                                        webix.message("Supplier added successfully");
                                                                        form.clear();
                                                                        datatable.clearAll();
                                                                        datatable.load("/api/retailSupply/suppliersGetter");
                                                                    }).fail(function (xhr) {
                                                                        try {
                                                                            var response = JSON.parse(xhr.responseText);
                                                                            webix.message({
                                                                                type: "error",
                                                                                text: response.message
                                                                            });
                                                                        } catch (e) {
                                                                            webix.message({ type: "error", text: "An unexpected error occurred." });
                                                                        }
                                                                    });
                                                            } else {
                                                                webix.message("Please fill out all fields in the form.");
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            {
                                                height: 450,
                                                view: "datatable",
                                                id: "supplierDatatable",
                                                editable: true,
                                                save: "/api/retailSupply/supplierUpdater",
                                                on: {
                                                    onValidationError: function (id, obj, value) {
                                                        webix.message({
                                                            type: "error",
                                                            text: `Please Imput data correctly in ${obj._id}`
                                                        });
                                                    },
                                                    onAfterEditStart: function (id) {
                                                        const editor = this.getEditor(id);
                                                        if (editor && editor.config.editor === "text") {
                                                            const inputNode = editor.getInputNode();
                                                            inputNode.setAttribute("maxlength", 20);
                                                            //
                                                        }
                                                    }
                                                },
                                                columns: [
                                                    {
                                                        id: "_id",
                                                        header: "Supplier ID",
                                                        name: "_id",
                                                        template: function (obj) {
                                                            return obj._id;
                                                        },
                                                        sort: 'string',
                                                        readonly: true
                                                    },
                                                    {
                                                        id: "supplierName",
                                                        header: "Supplier Name",
                                                        name: "name",
                                                        width: 130,
                                                        template: function (obj) {
                                                            return obj.supplierName;
                                                        },
                                                        editor: "text",
                                                        sort: 'string',

                                                    },
                                                    {
                                                        id: "contactPerson",
                                                        header: "Contact Person",
                                                        name: "contactPerson",
                                                        width: 140,
                                                        template: function (obj) {
                                                            return obj.contactPerson;
                                                        },
                                                        editor: "text",
                                                        sort: 'string',

                                                    },
                                                    {
                                                        id: "email",
                                                        header: "Email",
                                                        name: "email",
                                                        width: 180,
                                                        template: function (obj) {
                                                            return obj.email;
                                                        },
                                                        editor: "text",
                                                        sort: 'string',


                                                    },
                                                    {
                                                        id: "phone",
                                                        header: "Phone Number",
                                                        name: "phone",
                                                        width: 140,
                                                        template: function (obj) {
                                                            return obj.phone;
                                                        },

                                                        pattern: {
                                                            mask: "####-####-#####"
                                                        },
                                                        validate: function (value) {

                                                            return value
                                                                .length >= 10 &&
                                                                /^\d+$/.test(
                                                                    value
                                                                );
                                                        },
                                                        editor: "text",
                                                        sort: 'string'
                                                    },
                                                    {
                                                        id: "address",
                                                        header: "Address",
                                                        name: "address",
                                                        width: 250,
                                                        template: function (obj) {
                                                            return obj.address;
                                                        },
                                                        editor: "text",
                                                        sort: 'string',

                                                    },
                                                    {
                                                        id: "actions",
                                                        header: "Actions",
                                                        template: function (obj) {
                                                            return `<button onclick="deleteSupplier('${obj._id}')" style="margin-top:10px !important;">Delete</button>`;
                                                        },
                                                        width: 100
                                                    }
                                                ], rules: {
                                                    "supplierName": webix.rules.isNotEmpty,
                                                    "contactPerson": webix.rules.isNotEmpty,
                                                    "address": webix.rules.isNotEmpty,
                                                    "email": function (value) {
                                                        if (!webix.rules.isNotEmpty(value)) return false;
                                                        return webix.rules.isEmail(value);
                                                    },
                                                    "phone": function (value) {
                                                        if (!webix.rules.isNotEmpty(value)) return false;
                                                        var cleanValue = value.replace(/-/g, "");
                                                        var isNum = /^\d+$/.test(cleanValue);
                                                        return isNum && cleanValue.length >= 10 && cleanValue.length <= 13;
                                                    }
                                                },
                                                url: "/api/retailSupply/suppliersGetter",
                                            },
                                            {}
                                        ]
                                    },
                                    {
                                        paddingX: 5,
                                        type: "clean",
                                        rows: [
                                            {
                                                type: "clean",
                                                view: "form",
                                                id: "RetailForm",
                                                elements: [
                                                    {
                                                        id: "retailIdForm",
                                                        name: "_id",
                                                        hidden: true
                                                    },
                                                    {
                                                        id: "retailNameForm",
                                                        name: "retailName",
                                                        labelWidth: 170,
                                                        label: "Retail Name",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailContactPersonForm",
                                                        name: "retailContactPerson",
                                                        labelWidth: 170,
                                                        label: "Retail Contact Person",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailEmailForm",
                                                        name: "retailEmail",
                                                        labelWidth: 170,
                                                        label: "Retail Email",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailPhoneForm",
                                                        name: "retailPhoneNumber",
                                                        view: "text",
                                                        labelWidth: 170,
                                                        label: "Retail Phone Number",
                                                        attributes: {
                                                            maxlength: 13
                                                        },
                                                        pattern: {
                                                            mask: "####-####-#####"
                                                        },
                                                        validate: function (value) {

                                                            return value
                                                                .length >= 10 &&
                                                                /^\d+$/.test(
                                                                    value
                                                                );
                                                        },
                                                        required: true
                                                    },
                                                    {
                                                        id: "retailAddressForm",
                                                        name: "retailAddress",
                                                        labelWidth: 170,
                                                        label: "Retail Address",
                                                        view: "text",
                                                        required: true,
                                                        attributes: {
                                                            maxlength: 50
                                                        }
                                                    }
                                                ],
                                                rules: {
                                                    "retailEmail": function (value) {
                                                        if (!webix.rules.isNotEmpty(
                                                            value))
                                                            return false;
                                                        return webix.rules.isEmail(
                                                            value);
                                                    }, "noTelp": function (value) {
                                                        return webix.rules.isNotEmpty(value) && !isNaN(value) && value.length >= 10 && /^\d+$/.test(value) && value.length < 14;
                                                    }
                                                },
                                                on: {
                                                    "onValidationError": function (id, obj, value) {
                                                        webix.message({
                                                            type: "error",
                                                            text: "Please Imput data correctly"
                                                        });
                                                    }
                                                }
                                            },
                                            {
                                                paddingY: 20,
                                                cols: [
                                                    {
                                                        view: "button",
                                                        value: "Cancel",
                                                        click: function () {
                                                            $$("RetailForm").clear();
                                                        }
                                                    },
                                                    {
                                                        view: "button",
                                                        css: "webix_primary",
                                                        value: "Add Retail Data",
                                                        click: function () {
                                                            let form = $$("RetailForm");
                                                            let datatable = $$("retailDatatable");
                                                            if (form.validate()) {
                                                                webix.ajax()
                                                                    .headers({ "Content-Type": "application/json" })
                                                                    .post("/api/retailSupply/retailCreator", form.getValues(), function (response) {
                                                                        webix.message("Retail added successfully");
                                                                        form.clear();
                                                                        datatable.clearAll();
                                                                        datatable.load("/api/retailSupply/retailGetter");
                                                                    }).fail(function (xhr) {
                                                                        try {
                                                                            var response = JSON.parse(xhr.responseText);
                                                                            webix.message({
                                                                                type: "error",
                                                                                text: response.message
                                                                            });
                                                                        } catch (e) {
                                                                            webix.message({ type: "error", text: "An unexpected error occurred." });
                                                                        }
                                                                    });
                                                            } else {
                                                                webix.message("Please fill out all fields in the form.");
                                                            }
                                                        }
                                                    }
                                                ]
                                            },
                                            {
                                                height: 450,
                                                view: "datatable",
                                                id: "retailDatatable",
                                                editable: true,
                                                save: "/api/retailSupply/retailUpdater",
                                                rules: {
                                                    "retailEmail": function (value) {
                                                        if (!webix.rules.isNotEmpty(
                                                            value))
                                                            return false;
                                                        return webix.rules.isEmail(
                                                            value);
                                                    }, "retailPhoneNumber": function (value) {
                                                        return webix.rules.isNotEmpty(value) && !isNaN(value) && value.length >= 10 && /^\d+$/.test(value) && value.length < 14;
                                                    },
                                                    "retailName": webix.rules.isNotEmpty,
                                                    "retailContactPerson": webix.rules.isNotEmpty,
                                                    "retailAddress": webix.rules.isNotEmpty
                                                },
                                                on: {
                                                    onValidationError: function (id, obj, value) {
                                                        webix.message({
                                                            type: "error",
                                                            text: `Please Imput data correctly in ${obj._id}`
                                                        });
                                                    },
                                                    onAfterEditStart: function (id) {
                                                        const editor = this.getEditor(id);
                                                        if (editor && editor.config.editor === "text") {
                                                            const inputNode = editor.getInputNode();
                                                            inputNode.setAttribute("maxlength", 20);
                                                        }
                                                    }
                                                },
                                                columns: [
                                                    {
                                                        id: "_id",
                                                        header: "Retail ID",
                                                        name: "_id",
                                                        template: function (obj) {
                                                            return obj._id;
                                                        },
                                                        sort: 'string',
                                                        readonly: true
                                                    },
                                                    {
                                                        id: "retailName",
                                                        header: "Retail Name",
                                                        name: "name",
                                                        width: 130,
                                                        template: function (obj) {
                                                            return obj.retailName;
                                                        },
                                                        sort: 'string',
                                                        editor: "text",
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailContactPerson",
                                                        header: "Contact Person",
                                                        name: "contactPerson",
                                                        width: 140,
                                                        template: function (obj) {
                                                            return obj.retailContactPerson;
                                                        },
                                                        sort: 'string',
                                                        editor: "text",
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailPhoneNumber",
                                                        header: "Phone Number",
                                                        name: "phoneNumber",
                                                        width: 140,
                                                        template: function (obj) {
                                                            return obj.retailPhoneNumber;
                                                        },
                                                        attributes: {
                                                            maxlength: 13
                                                        },
                                                        pattern: {
                                                            mask: "####-####-#####"
                                                        },
                                                        validate: function (value) {

                                                            return value
                                                                .length >= 10 &&
                                                                /^\d+$/.test(
                                                                    value
                                                                );
                                                        },
                                                        sort: 'string',
                                                        editor: "text"
                                                    },
                                                    {
                                                        id: "retailEmail",
                                                        header: "Email",
                                                        name: "email",
                                                        width: 180,
                                                        template: function (obj) {
                                                            return obj.retailEmail;
                                                        },
                                                        sort: 'string',
                                                        editor: "text",
                                                        attributes: {
                                                            maxlength: 40
                                                        }
                                                    },
                                                    {
                                                        id: "retailAddress",
                                                        header: "Address",
                                                        name: "retailAddress",
                                                        width: 250,
                                                        template: function (obj) {
                                                            return obj.retailAddress;
                                                        },
                                                        sort: 'string',
                                                        editor: "text",
                                                        attributes: {
                                                            maxlength: 50
                                                        }
                                                    },
                                                    {
                                                        id: "actions",
                                                        header: "Actions",
                                                        template: function (obj) {
                                                            return `<button onclick="deleteRetail('${obj._id}')" style="margin-top:10px !important;">Delete</button>`;
                                                        },
                                                        width: 100
                                                    }
                                                ],
                                                url: "/api/retailSupply/retailGetter",
                                            },
                                            {}
                                        ]
                                    }
                                ]
                            },
                            {}
                            ]
                        }
                    }
                    ]
                }
                ]
            });
            webix.ui.fullScreen();
            if ($$('log_form')) {
                $$('log_form').clear();
            };
            if ($$("mainSidebar")) {
                $$("mainSidebar").select("supplyAndRetailManagement");

                var sidebarRoutes = {
                    dashboard: "/",
                    product_management: "/management/product",
                    users_management: "/management/users",
                    supplyAndRetailManagement: "/retail-supply"
                };
                $$("mainSidebar").attachEvent("onAfterSelect", function (id) {
                    var target = sidebarRoutes[id] || "/";
                    window.location.href = target;
                    return true;
                });
            };
        })
    </script>
</body>

</html>